# BISMAN ERP — Production Startup

This repository includes scripts to build and run the Next.js frontend and NestJS backend together in production, managed by PM2 on a single origin (port 3000 for API + proxied frontend).

Quick summary
- The backend (Nest) listens on port 3000 and proxies non-API requests to a Next.js production server running on port 3001.
- `scripts/start-prod.sh` builds both apps, starts them under PM2 using `ecosystem.config.js`, and runs a smoke-test against `/health` and `/metrics`.
- `scripts/stop-prod.sh` removes the PM2-managed processes.
- `scripts/pm2-setup.sh` helps configure PM2 to start on boot. `scripts/setup-log-rotation.sh` configures `pm2-logrotate`.

Files of interest
- `scripts/start-prod.sh` — single-command automation to build and start the app in production (uses `npx pm2`).
- `scripts/stop-prod.sh` — stop and remove PM2 processes for this project.
- `ecosystem.config.js` — PM2 process definitions for `bisman-api` and `bisman-next`.
- `scripts/pm2-setup.sh` — helper to run `pm2 startup` + `pm2 save` (run once per server).
- `scripts/setup-log-rotation.sh` — helper to install/configure `pm2-logrotate`.
- `scripts/smoke-test.js` — runs simple HTTP checks against `/health` and `/metrics`.

Prerequisites
- Node.js and npm available on the server (the project has been tested with Node 18+ and npm 10/11).
- (Optional) Global pm2 is convenient; the scripts use `npx pm2` so a global install isn't required.

Start (one-command)
1. From the repo root run:

```bash
npm_config_cache="$(mktemp -d)" bash scripts/start-prod.sh
```

This will:
- Install dependencies (uses `npm ci` with a fallback to `npm install`).
- Build the Next frontend and compile the Nest backend.
- Start both processes under PM2 using `ecosystem.config.js`.
- Run an automated smoke-test against `/health` and `/metrics` on port 3000.

PM2 setup for boot persistence (run once)
1. Install pm2 globally (optional but recommended):

```bash
# optionally install globally
npm install -g pm2
```

2. Run the helper which prints the proper startup command for your OS and saves the process list:

```bash
bash scripts/pm2-setup.sh
# then follow any printed instructions (may require sudo/root)
```

Enable log rotation
1. Configure PM2's log rotation module with sensible defaults:

```bash
bash scripts/setup-log-rotation.sh
```

Stop the services

```bash
bash scripts/stop-prod.sh
```

Inspect logs and status
- List processes:

```bash
npx pm2 list
```

- Tail combined logs (pm2-managed):

```bash
npx pm2 logs
```

- Or view raw log files in `logs/` (created by PM2 per the ecosystem config):

```bash
ls -lah logs
tail -f logs/api.out.log
tail -f logs/next.out.log
```

Troubleshooting
- npm CI fails due to lockfile mismatch: the script falls back to `npm install`. To fix permanently keep package.json and package-lock.json in sync (run `npm install` locally and commit the updated lockfile).
- npm permission errors writing to `~/.npm/_cacache`: either fix ownership (`sudo chown -R $(whoami) ~/.npm`) or continue to run the start script using a temporary cache (the wrapper sets `npm_config_cache` by default if you used the example command).
- If PM2 appears to start other processes from a previously created `ecosystem.config.js`, ensure you use the repository root `ecosystem.config.js` we added; the start script invokes `npx pm2 start ecosystem.config.js --env production`.
- If the smoke-test times out, inspect `npx pm2 logs bisman-api` and `npx pm2 logs bisman-next` and then try `bash scripts/stop-prod.sh` and re-run `bash scripts/start-prod.sh`.

Design note
- We attempted to embed Next.js inside the Nest process directly (in-process) but Next's runtime assumptions caused stability issues in some environments. The current, robust approach runs Next as a separate production server and has Nest proxy UI requests — this maintains a single origin (port 3000) while keeping Next running where it expects to.

Security
- Do not commit secrets or credentials to the repo. Use environment variables or a secret manager for DB credentials and Sentry/OTel keys.

Contact / Next steps
- If you'd like, I can wire `pm2 save` into the start flow, or add a systemd unit instead of pm2 startup helpers. I can also add CI job steps to build artifacts and publish a deployable tarball.

---
Generated by automation scripts in this repository.

# bisman-ERP-Building

Full-Stack Runbook (Backend + Frontend)

Development (on your laptop)

1. Install dependencies:

	npm install

2. Start backend + frontend together:

	npm run dev

Result:

Backend → http://localhost:3000

Frontend → http://localhost:3001

Production (on a server, recommended)

1. Install dependencies:

	npm install

2. Build backend + frontend:

	npm run build:backend && npm run build:frontend

3. Install pm2 (only once):

	npm install -g pm2

4. Start services with pm2:

	pm2 start ecosystem.config.js --env production

5. Save and auto-start on reboot:

	pm2 save && pm2 startup

Health Check (Smoke Test)

Command: npm run smoke:test

Purpose: Checks that backend endpoints /health and /metrics return OK (200).

