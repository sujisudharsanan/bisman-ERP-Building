generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  // connection_limit = 5 // optional: uncomment to limit Prisma pool on supported providers
}

model Role {
  id   Int     @id @default(autoincrement())
  name String? @unique

  @@map("roles")
}

model User {
  id              Int             @id @default(autoincrement())
  username        String          @map("username") @db.VarChar(100)
  email           String          @unique @db.VarChar(150)
  password        String          @db.VarChar(255)
  role            String?         @db.VarChar(50)
  
  // Multi-tenant fields
  productType     String?         @default("BUSINESS_ERP") @db.VarChar(50) // "PUMP_ERP" | "BUSINESS_ERP" | "ALL"
  tenant_id       String?         @db.Uuid // For client-level users
  super_admin_id  Int?            // Reference to SuperAdmin managing this user
  
  createdAt       DateTime?       @default(now()) @map("created_at") @db.Timestamp(6)
  profile_pic_url String?         @map("profile_pic_url")
  updatedAt       DateTime?       @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  assignedModules Json?
  pagePermissions Json?
  
  // Relations
  client          Client?         @relation("ClientUsers", fields: [tenant_id], references: [id], onDelete: Cascade)
  superAdmin      SuperAdmin?     @relation("SuperAdminUsers", fields: [super_admin_id], references: [id], onDelete: SetNull)
  auditLogs       AuditLog[]
  user_sessions   user_sessions[]

  @@index([tenant_id], map: "idx_users_tenant")
  @@index([productType], map: "idx_users_product_type")
  @@index([super_admin_id], map: "idx_users_super_admin")
  @@map("users")
}

model AuditLog {
  id            Int            @id @default(autoincrement())
  user_id       Int?
  action        String         @db.VarChar(50)
  table_name    String?        @db.VarChar(100)
  record_id     Int?
  old_values    Json?
  new_values    Json?
  ip_address    String?        @db.Inet
  user_agent    String?
  session_id    Int?
  created_at    DateTime?      @default(now()) @db.Timestamp(6)
  user_sessions user_sessions? @relation(fields: [session_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user          User?          @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([action], map: "idx_audit_logs_action")
  @@index([user_id], map: "idx_audit_logs_user")
  @@map("audit_logs")
}

model actions {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(100)
  description String?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
}

model migration_history {
  id             Int       @id @default(autoincrement())
  migration_name String    @unique @db.VarChar(255)
  applied_at     DateTime? @default(now()) @db.Timestamptz(6)
  applied_by     String?   @default(dbgenerated("CURRENT_USER")) @db.VarChar(100)
  backup_file    String?
  checksum       String?
}

model rbac_actions {
  id               Int                @id @default(autoincrement())
  name             String             @unique @db.VarChar(100)
  description      String?
  created_at       DateTime?          @default(now()) @db.Timestamp(6)
  display_name     String?            @db.VarChar(100)
  is_active        Boolean?           @default(true)
  rbac_permissions rbac_permissions[]
}

model rbac_permissions {
  id           Int           @id @default(autoincrement())
  role_id      Int?
  action_id    Int?
  route_id     Int?
  granted      Boolean?      @default(false)
  created_at   DateTime?     @default(now()) @db.Timestamp(6)
  updated_at   DateTime?     @default(now()) @db.Timestamp(6)
  name         String?       @db.VarChar(200)
  display_name String?       @db.VarChar(250)
  is_active    Boolean?      @default(true)
  rbac_actions rbac_actions? @relation(fields: [action_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rbac_roles   rbac_roles?   @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rbac_routes  rbac_routes?  @relation(fields: [route_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([role_id, action_id, route_id])
  @@index([action_id], map: "idx_rbac_permissions_action_id")
  @@index([is_active], map: "idx_rbac_permissions_active")
  @@index([name], map: "idx_rbac_permissions_name")
  @@index([role_id], map: "idx_rbac_permissions_role_id")
  @@index([route_id], map: "idx_rbac_permissions_route_id")
}

model rbac_roles {
  id               Int                @id @default(autoincrement())
  name             String             @unique @db.VarChar(50)
  description      String?
  level            Int?               @default(1)
  created_at       DateTime?          @default(now()) @db.Timestamp(6)
  updated_at       DateTime?          @default(now()) @db.Timestamp(6)
  display_name     String?            @db.VarChar(150)
  status           String?            @default("active") @db.VarChar(20)
  rbac_permissions rbac_permissions[]
  rbac_user_roles  rbac_user_roles[]
}

model rbac_routes {
  id               Int                @id @default(autoincrement())
  path             String             @db.VarChar(255)
  name             String             @db.VarChar(100)
  description      String?
  method           String?            @default("GET") @db.VarChar(10)
  module           String?            @db.VarChar(50)
  is_protected     Boolean?           @default(true)
  created_at       DateTime?          @default(now()) @db.Timestamp(6)
  display_name     String?            @db.VarChar(200)
  is_active        Boolean?           @default(true)
  is_menu_item     Boolean?           @default(true)
  icon             String?            @db.VarChar(100)
  sort_order       Int?               @default(0)
  rbac_permissions rbac_permissions[]

  @@unique([path, method])
  @@index([is_active], map: "idx_rbac_routes_active")
  @@index([is_menu_item], map: "idx_rbac_routes_menu")
}

model rbac_user_roles {
  id          Int         @id @default(autoincrement())
  user_id     Int
  role_id     Int?
  assigned_at DateTime?   @default(now()) @db.Timestamp(6)
  assigned_by Int?
  is_active   Boolean?    @default(true)
  expires_at  DateTime?   @db.Timestamp(6)
  rbac_roles  rbac_roles? @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, role_id])
  @@index([is_active], map: "idx_rbac_user_roles_active")
  @@index([role_id], map: "idx_rbac_user_roles_role_id")
  @@index([user_id], map: "idx_rbac_user_roles_user_id")
}

model rbac_user_permissions {
  id         Int      @id @default(autoincrement())
  user_id    Int
  page_key   String   @db.VarChar(255)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  @@unique([user_id, page_key])
  @@index([user_id], map: "idx_user_permissions_user_id")
}

model recent_activity {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    Int?
  username   String?   @db.VarChar(255)
  action     String
  entity     String
  entity_id  String?
  details    Json?
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at(sort: Desc)], map: "idx_recent_activity_created_at")
  @@index([entity], map: "idx_recent_activity_entity")
  @@index([user_id], map: "idx_recent_activity_user_id")
}

model routes {
  id           Int       @id @default(autoincrement())
  path         String    @db.VarChar(255)
  name         String    @db.VarChar(100)
  description  String?
  method       String?   @default("GET") @db.VarChar(10)
  module       String?   @db.VarChar(50)
  is_protected Boolean?  @default(true)
  created_at   DateTime? @default(now()) @db.Timestamp(6)

  @@unique([path, method])
}

model user_sessions {
  id               Int        @id @default(autoincrement())
  user_id          Int
  session_token    String     @unique @db.VarChar(255)
  ip_address       String?    @db.Inet
  user_agent       String?
  created_at       DateTime?  @default(now()) @db.Timestamp(6)
  expires_at       DateTime   @db.Timestamp(6)
  last_activity_at DateTime?  @default(now()) @db.Timestamp(6)
  is_active        Boolean?   @default(true)
  audit_logs       AuditLog[]
  users            User       @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([session_token], map: "idx_user_sessions_token")
  @@index([user_id], map: "idx_user_sessions_user")
}

// ==========================================
// MULTI-TENANT SAAS TABLES
// ==========================================

model EnterpriseAdmin {
  id              Int          @id @default(autoincrement())
  name            String       @db.VarChar(100)
  email           String       @unique @db.VarChar(150)
  password        String       @db.VarChar(255)
  profile_pic_url String?
  is_active       Boolean      @default(true)
  created_at      DateTime     @default(now()) @db.Timestamp(6)
  updated_at      DateTime     @default(now()) @updatedAt @db.Timestamp(6)
  
  // Relations
  superAdmins     SuperAdmin[] @relation("CreatedSuperAdmins")

  @@map("enterprise_admins")
}

model SuperAdmin {
  id              Int              @id @default(autoincrement())
  name            String           @db.VarChar(100)
  email           String           @unique @db.VarChar(150)
  password        String           @db.VarChar(255)
  productType     String           @db.VarChar(50) // "PUMP_ERP" | "BUSINESS_ERP"
  profile_pic_url String?
  is_active       Boolean          @default(true)
  created_at      DateTime         @default(now()) @db.Timestamp(6)
  updated_at      DateTime         @default(now()) @updatedAt @db.Timestamp(6)
  
  // Relations
  created_by      Int
  enterpriseAdmin EnterpriseAdmin  @relation("CreatedSuperAdmins", fields: [created_by], references: [id], onDelete: Cascade)
  clients         Client[]         @relation("SuperAdminClients")
  users           User[]           @relation("SuperAdminUsers")
  moduleAssignments ModuleAssignment[]

  @@index([productType], map: "idx_super_admins_product_type")
  @@index([created_by], map: "idx_super_admins_created_by")
  @@map("super_admins")
}

model Client {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String    @db.VarChar(200)
  productType        String    @db.VarChar(50) // "PUMP_ERP" | "BUSINESS_ERP"
  super_admin_id     Int
  
  // Subscription & Settings
  subscriptionPlan   String    @default("free") @db.VarChar(50)
  subscriptionStatus String    @default("active") @db.VarChar(50)
  is_active          Boolean   @default(true)
  settings           Json?
  logo               String?
  
  // Metadata
  created_at         DateTime  @default(now()) @db.Timestamp(6)
  updated_at         DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  
  // Relations
  superAdmin         SuperAdmin @relation("SuperAdminClients", fields: [super_admin_id], references: [id], onDelete: Cascade)
  users              User[]     @relation("ClientUsers")

  @@index([super_admin_id], map: "idx_clients_super_admin")
  @@index([productType], map: "idx_clients_product_type")
  @@map("clients")
}

model Module {
  id             Int        @id @default(autoincrement())
  module_name    String     @unique @db.VarChar(100)
  display_name   String     @db.VarChar(150)
  description    String?
  route          String     @db.VarChar(255)
  icon           String?    @db.VarChar(100)
  productType    String     @db.VarChar(50) // "PUMP_ERP" | "BUSINESS_ERP" | "ALL"
  is_active      Boolean    @default(true)
  sort_order     Int?       @default(0)
  created_at     DateTime   @default(now()) @db.Timestamp(6)
  updated_at     DateTime   @default(now()) @updatedAt @db.Timestamp(6)
  
  // Relations
  permissions    Permission[]
  moduleAssignments ModuleAssignment[]

  @@index([productType], map: "idx_modules_product_type")
  @@index([is_active], map: "idx_modules_active")
  @@map("modules")
}

model Permission {
  id          Int      @id @default(autoincrement())
  role        String   @db.VarChar(50) // Role name
  module_id   Int
  can_view    Boolean  @default(false)
  can_create  Boolean  @default(false)
  can_edit    Boolean  @default(false)
  can_delete  Boolean  @default(false)
  created_at  DateTime @default(now()) @db.Timestamp(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamp(6)
  
  // Relations
  module      Module   @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@unique([role, module_id])
  @@index([role], map: "idx_permissions_role")
  @@index([module_id], map: "idx_permissions_module")
  @@map("permissions")
}

model ModuleAssignment {
  id              Int        @id @default(autoincrement())
  super_admin_id  Int
  module_id       Int
  assigned_at     DateTime   @default(now()) @db.Timestamp(6)
  page_permissions Json?     // Array of page IDs that are assigned
  
  // Relations
  superAdmin      SuperAdmin @relation(fields: [super_admin_id], references: [id], onDelete: Cascade)
  module          Module     @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@unique([super_admin_id, module_id])
  @@index([super_admin_id], map: "idx_module_assignments_super_admin")
  @@index([module_id], map: "idx_module_assignments_module")
  @@map("module_assignments")
}
