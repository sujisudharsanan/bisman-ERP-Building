generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Role {
  id   Int     @id @default(autoincrement())
  name String? @unique

  @@map("roles")
}

model User {
  id                     Int                     @id @default(autoincrement())
  username               String                  @map("username") @db.VarChar(100)
  email                  String                  @unique @db.VarChar(150)
  password_hash          String                  @map("password_hash") @db.VarChar(255)
  role                   String?                 @db.VarChar(50)
  is_active              Boolean                 @default(true)
  productType            String?                 @default("BUSINESS_ERP") @db.VarChar(50)
  tenant_id              String?                 @db.Uuid
  super_admin_id         Int?
  created_by             Int?
  createdAt              DateTime?               @default(now()) @map("created_at") @db.Timestamp(6)
  profile_pic_url        String?                 @map("profile_pic_url")
  updatedAt              DateTime?               @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  assignedModules        Json?
  pagePermissions        Json?
  theme_preference       String?                 @default("bisman-default") @db.VarChar(50)
  approvals              Approval[]              @relation("TaskApprovals")
  approverConfigurations ApproverConfiguration[] @relation("ApproverConfigurations")
  approverSelectionLogs  ApproverSelectionLog[]  @relation("ApproverSelectionLogs")
  assistantMemory        AssistantMemory?        @relation("AssistantMemoryUser")
  auditLogs              AuditLog[]
  billsUploaded          Bill[]                  @relation("BillUploader")
  initiatedCallLogs      CallLog[]               @relation("CallLogInitiator")
  usageEvents            ClientUsageEvent[]
  expensesCreated        Expense[]               @relation("ExpenseCreator")
  messages               Message[]               @relation("TaskMessages")
  paymentActivityLogs    PaymentActivityLog[]    @relation("PaymentActivityLogs")
  paymentRecords         PaymentRecord[]         @relation("PaymentRecords")
  paymentRequestsCreated PaymentRequest[]        @relation("PaymentRequestCreator")
  tasksAssigned          Task[]                  @relation("TaskAssignee")
  tasksCreated           Task[]                  @relation("TaskCreator")
  threadMembers          ThreadMember[]          @relation("ThreadMemberUser")
  threadMessagesSent     ThreadMessage[]         @relation("ThreadMessageSender")
  threadsCreated         Thread[]                @relation("ThreadCreatedBy")
  achievements           UserAchievement[]
  addresses              UserAddress[]
  bankAccounts           UserBankAccount[]
  branches               UserBranch[]
  education              UserEducation[]
  emergencyContacts      UserEmergencyContact[]
  kyc                    UserKYC?
  profile                UserProfile?
  user_sessions          user_sessions[]
  skills                 UserSkill[]
  superAdmin             SuperAdmin?             @relation("SuperAdminUsers", fields: [super_admin_id], references: [id])
  client                 Client?                 @relation("ClientUsers", fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id], map: "idx_users_tenant")
  @@index([productType], map: "idx_users_product_type")
  @@index([super_admin_id], map: "idx_users_super_admin")
  @@index([is_active], map: "idx_users_active")
  @@map("users")
}

model AuditLog {
  id            Int            @id @default(autoincrement())
  user_id       Int?
  action        String         @db.VarChar(50)
  table_name    String?        @db.VarChar(100)
  record_id     Int?
  old_values    Json?
  new_values    Json?
  ip_address    String?        @db.Inet
  user_agent    String?
  session_id    Int?
  created_at    DateTime?      @default(now()) @db.Timestamp(6)
  user_sessions user_sessions? @relation(fields: [session_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user          User?          @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([action], map: "idx_audit_logs_action")
  @@index([user_id], map: "idx_audit_logs_user")
  @@map("audit_logs")
}

model actions {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(100)
  description String?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
}

model migration_history {
  id             Int       @id @default(autoincrement())
  migration_name String    @unique @db.VarChar(255)
  applied_at     DateTime? @default(now()) @db.Timestamptz(6)
  applied_by     String?   @default(dbgenerated("CURRENT_USER")) @db.VarChar(100)
  backup_file    String?
  checksum       String?
}

model rbac_actions {
  id               Int                @id @default(autoincrement())
  name             String             @unique @db.VarChar(100)
  description      String?
  created_at       DateTime?          @default(now()) @db.Timestamp(6)
  display_name     String?            @db.VarChar(100)
  is_active        Boolean?           @default(true)
  rbac_permissions rbac_permissions[]
}

model rbac_permissions {
  id             Int           @id @default(autoincrement())
  role_id        Int?
  action_id      Int?
  route_id       Int?
  granted        Boolean?      @default(false)
  created_at     DateTime?     @default(now()) @db.Timestamp(6)
  updated_at     DateTime?     @default(now()) @db.Timestamp(6)
  name           String?       @db.VarChar(200)
  display_name   String?       @db.VarChar(250)
  is_active      Boolean?      @default(true)
  min_role_level Int?          @default(0)
  rbac_actions   rbac_actions? @relation(fields: [action_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rbac_roles     rbac_roles?   @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rbac_routes    rbac_routes?  @relation(fields: [route_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([role_id, action_id, route_id])
  @@index([action_id], map: "idx_rbac_permissions_action_id")
  @@index([is_active], map: "idx_rbac_permissions_active")
  @@index([name], map: "idx_rbac_permissions_name")
  @@index([role_id], map: "idx_rbac_permissions_role_id")
  @@index([route_id], map: "idx_rbac_permissions_route_id")
  @@index([min_role_level], map: "idx_rbac_permissions_min_role_level")
}

model rbac_roles {
  id               Int                @id @default(autoincrement())
  name             String             @unique @db.VarChar(50)
  description      String?
  level            Int?               @default(1)
  created_at       DateTime?          @default(now()) @db.Timestamp(6)
  updated_at       DateTime?          @default(now()) @db.Timestamp(6)
  display_name     String?            @db.VarChar(150)
  status           String?            @default("active") @db.VarChar(20)
  rbac_permissions rbac_permissions[]
  rbac_user_roles  rbac_user_roles[]
}

model rbac_routes {
  id               Int                @id @default(autoincrement())
  path             String             @db.VarChar(255)
  name             String             @db.VarChar(100)
  description      String?
  method           String?            @default("GET") @db.VarChar(10)
  module           String?            @db.VarChar(50)
  is_protected     Boolean?           @default(true)
  created_at       DateTime?          @default(now()) @db.Timestamp(6)
  display_name     String?            @db.VarChar(200)
  is_active        Boolean?           @default(true)
  is_menu_item     Boolean?           @default(true)
  icon             String?            @db.VarChar(100)
  sort_order       Int?               @default(0)
  rbac_permissions rbac_permissions[]

  @@unique([path, method])
  @@index([is_active], map: "idx_rbac_routes_active")
  @@index([is_menu_item], map: "idx_rbac_routes_menu")
}

model rbac_user_roles {
  id          Int         @id @default(autoincrement())
  user_id     Int
  role_id     Int?
  assigned_at DateTime?   @default(now()) @db.Timestamp(6)
  assigned_by Int?
  is_active   Boolean?    @default(true)
  expires_at  DateTime?   @db.Timestamp(6)
  rbac_roles  rbac_roles? @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, role_id])
  @@index([is_active], map: "idx_rbac_user_roles_active")
  @@index([role_id], map: "idx_rbac_user_roles_role_id")
  @@index([user_id], map: "idx_rbac_user_roles_user_id")
}

model rbac_user_permissions {
  id         Int      @id @default(autoincrement())
  user_id    Int
  page_key   String   @db.VarChar(255)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  @@unique([user_id, page_key])
  @@index([user_id], map: "idx_user_permissions_user_id")
}

model recent_activity {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    Int?
  username   String?   @db.VarChar(255)
  action     String
  entity     String
  entity_id  String?
  details    Json?
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at(sort: Desc)], map: "idx_recent_activity_created_at")
  @@index([entity], map: "idx_recent_activity_entity")
  @@index([user_id], map: "idx_recent_activity_user_id")
}

model routes {
  id           Int       @id @default(autoincrement())
  path         String    @db.VarChar(255)
  name         String    @db.VarChar(100)
  description  String?
  method       String?   @default("GET") @db.VarChar(10)
  module       String?   @db.VarChar(50)
  is_protected Boolean?  @default(true)
  created_at   DateTime? @default(now()) @db.Timestamp(6)

  @@unique([path, method])
}

model user_sessions {
  id               Int        @id @default(autoincrement())
  user_id          Int
  // DEPRECATED: Use token_hash for lookups
  session_token    String     @unique @db.VarChar(255)
  // Hashed token fields (SHA-256)
  token_hash       String?    @db.VarChar(64)
  token_prefix     String?    @db.VarChar(8)
  ip_address       String?    @db.Inet
  user_agent       String?
  created_at       DateTime?  @default(now()) @db.Timestamp(6)
  expires_at       DateTime   @db.Timestamp(6)
  last_activity_at DateTime?  @default(now()) @db.Timestamp(6)
  is_active        Boolean?   @default(true)
  audit_logs       AuditLog[]
  users            User       @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([session_token], map: "idx_user_sessions_token")
  @@index([token_hash], map: "idx_user_sessions_token_hash")
  @@index([user_id], map: "idx_user_sessions_user")
}

model EnterpriseAdmin {
  id              Int          @id @default(autoincrement())
  name            String       @db.VarChar(100)
  email           String       @unique @db.VarChar(150)
  password_hash   String       @map("password_hash") @db.VarChar(255)
  profile_pic_url String?
  is_active       Boolean      @default(true)
  created_at      DateTime     @default(now()) @db.Timestamp(6)
  updated_at      DateTime     @default(now()) @updatedAt @db.Timestamp(6)
  superAdmins     SuperAdmin[] @relation("CreatedSuperAdmins")

  @@map("enterprise_admins")
}

model SuperAdmin {
  id                Int                @id @default(autoincrement())
  name              String             @db.VarChar(100)
  email             String             @unique @db.VarChar(150)
  password_hash     String             @map("password_hash") @db.VarChar(255)
  productType       String             @db.VarChar(50)
  profile_pic_url   String?
  is_active         Boolean            @default(true)
  created_at        DateTime           @default(now()) @db.Timestamp(6)
  updated_at        DateTime           @default(now()) @updatedAt @db.Timestamp(6)
  created_by        Int
  clients           Client[]           @relation("SuperAdminClients")
  moduleAssignments ModuleAssignment[]
  enterpriseAdmin   EnterpriseAdmin    @relation("CreatedSuperAdmins", fields: [created_by], references: [id], onDelete: Cascade)
  users             User[]             @relation("SuperAdminUsers")

  @@index([productType], map: "idx_super_admins_product_type")
  @@index([created_by], map: "idx_super_admins_created_by")
  @@map("super_admins")
}

model Client {
  id                      String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                    String                     @db.VarChar(200)
  client_code             String?                    @unique @db.VarChar(50)
  public_code             String?                    @unique @db.VarChar(50)
  client_number           BigInt?                    @unique
  legal_name              String?                    @db.VarChar(200)
  trade_name              String?                    @db.VarChar(200)
  client_type             String?                    @db.VarChar(50)
  industry                String?                    @db.VarChar(100)
  business_size           String?                    @db.VarChar(50)
  registration_number     String?                    @db.VarChar(100)
  tax_id                  String?                    @db.VarChar(50)
  legal_status            String?                    @db.VarChar(50)
  import_export_code      String?                    @db.VarChar(50)
  registration_year       Int?
  addresses               Json?
  contact_persons         Json?
  financial_details       Json?
  bank_details            Json?
  documents               Json?
  system_access           Json?
  operational             Json?
  risk                    Json?
  status                  String?                    @default("Active") @db.VarChar(30)
  onboarding_status       String?                    @default("pending") @db.VarChar(30)
  trial_start_date        DateTime?                  @db.Timestamp(6)
  trial_end_date          DateTime?                  @db.Timestamp(6)
  modules_enabled         Json?
  notification_prefs      Json?
  preferred_language      String?                    @db.VarChar(10)
  timezone                String?                    @db.VarChar(100)
  mfa_enabled             Boolean?                   @default(false)
  duplicate_check         Json?
  onboarding_activity     Json?
  onboarding_date         DateTime?                  @db.Timestamp(6)
  first_invoice_date      DateTime?                  @db.Timestamp(6)
  last_activity_date      DateTime?                  @db.Timestamp(6)
  auto_disable_rules      Json?
  productType             String                     @db.VarChar(50)
  super_admin_id          Int
  subscriptionPlan        String                     @default("free") @db.VarChar(50)
  subscriptionStatus      String                     @default("active") @db.VarChar(50)
  is_active               Boolean                    @default(true)
  settings                Json?
  logo                    String?
  created_at              DateTime                   @default(now()) @db.Timestamp(6)
  updated_at              DateTime                   @default(now()) @updatedAt @db.Timestamp(6)
  ClientToClientSequence  ClientToClientSequence[]
  branches                Branch[]
  dailyUsage              ClientDailyUsage[]
  clientModulePermissions ClientModulePermission[]
  onboardingActivities    ClientOnboardingActivity[]
  usageEvents             ClientUsageEvent[]
  superAdmin              SuperAdmin                 @relation("SuperAdminClients", fields: [super_admin_id], references: [id], onDelete: Cascade)
  onboardingMagicLinks    OnboardingMagicLink[]
  paymentRequests         PaymentRequest[]           @relation("ClientPaymentRequests")
  users                   User[]                     @relation("ClientUsers")
  events                  Event[]                    @relation("ClientEvents")

  @@index([super_admin_id], map: "idx_clients_super_admin")
  @@index([productType], map: "idx_clients_product_type")
  @@index([client_code], map: "idx_clients_code")
  @@map("clients")
}

model ClientSequence {
  id                     Int                      @id @default(autoincrement())
  client_type            String                   @db.VarChar(50)
  year                   Int
  last_number            BigInt                   @default(0)
  updated_at             DateTime                 @default(now()) @updatedAt @db.Timestamp(6)
  ClientToClientSequence ClientToClientSequence[]

  @@unique([client_type, year])
  @@map("client_sequences")
}

model OnboardingMagicLink {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id  String?   @db.Uuid
  email      String?   @db.VarChar(150)
  token_hash String    @db.VarChar(255)
  expires_at DateTime  @db.Timestamp(6)
  used_at    DateTime? @db.Timestamp(6)
  created_at DateTime  @default(now()) @db.Timestamp(6)
  created_ip String?   @db.Inet
  user_agent String?   @db.VarChar(255)
  client     Client?   @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([client_id], map: "idx_onboarding_magic_link_client")
  @@index([expires_at], map: "idx_onboarding_magic_link_expires")
  @@map("onboarding_magic_links")
}

model ClientOnboardingActivity {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id   String   @db.Uuid
  step_key    String   @db.VarChar(100)
  action      String   @db.VarChar(50)
  meta        Json?
  actor_email String?  @db.VarChar(150)
  created_at  DateTime @default(now()) @db.Timestamp(6)
  client      Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([client_id], map: "idx_onboarding_activity_client")
  @@index([step_key], map: "idx_onboarding_activity_step")
  @@map("client_onboarding_activity")
}

model Module {
  id                      Int                      @id @default(autoincrement())
  module_name             String                   @unique @db.VarChar(100)
  display_name            String                   @db.VarChar(150)
  description             String?
  route                   String                   @db.VarChar(255)
  icon                    String?                  @db.VarChar(100)
  productType             String                   @db.VarChar(50)
  is_active               Boolean                  @default(true)
  is_always_accessible    Boolean                  @default(false) // Common & Chat modules are always accessible
  sort_order              Int?                     @default(0)
  created_at              DateTime                 @default(now()) @db.Timestamp(6)
  updated_at              DateTime                 @default(now()) @updatedAt @db.Timestamp(6)
  dailyUsage              ClientDailyUsage[]
  clientModulePermissions ClientModulePermission[]
  usageEvents             ClientUsageEvent[]
  moduleAssignments       ModuleAssignment[]
  permissions             Permission[]

  @@index([productType], map: "idx_modules_product_type")
  @@index([is_active], map: "idx_modules_active")
  @@map("modules")
}

model Permission {
  id         Int      @id @default(autoincrement())
  role       String   @db.VarChar(50)
  module_id  Int
  can_view   Boolean  @default(false)
  can_create Boolean  @default(false)
  can_edit   Boolean  @default(false)
  can_delete Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamp(6)
  module     Module   @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@unique([role, module_id])
  @@index([role], map: "idx_permissions_role")
  @@index([module_id], map: "idx_permissions_module")
  @@map("permissions")
}

model ModuleAssignment {
  id               Int        @id @default(autoincrement())
  super_admin_id   Int
  module_id        Int
  assigned_at      DateTime   @default(now()) @db.Timestamp(6)
  page_permissions Json?
  module           Module     @relation(fields: [module_id], references: [id], onDelete: Cascade)
  superAdmin       SuperAdmin @relation(fields: [super_admin_id], references: [id], onDelete: Cascade)

  @@unique([super_admin_id, module_id])
  @@index([super_admin_id], map: "idx_module_assignments_super_admin")
  @@index([module_id], map: "idx_module_assignments_module")
  @@map("module_assignments")
}

// Unified Admin Role Assignment - For Enterprise Admin, Super Admin, and Admin role allocations
// This table stores which roles are assigned/allocated by each admin level
model AdminRoleAssignment {
  id            Int      @id @default(autoincrement())
  assigner_type String   @db.VarChar(50) // 'ENTERPRISE_ADMIN', 'SUPER_ADMIN', 'ADMIN'
  assigner_id   Int // ID of the admin who assigned
  role_id       Int // ID of the role being assigned (references rbac_roles)
  assignee_type String?  @db.VarChar(50) // 'SUPER_ADMIN', 'ADMIN', 'USER' (who receives the role)
  assignee_id   Int? // Optional: specific user receiving the role
  is_active     Boolean  @default(true)
  assigned_at   DateTime @default(now()) @db.Timestamp(6)
  updated_at    DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@unique([assigner_type, assigner_id, role_id, assignee_type, assignee_id])
  @@index([assigner_type, assigner_id], map: "idx_admin_role_assign_assigner")
  @@index([role_id], map: "idx_admin_role_assign_role")
  @@index([assignee_id], map: "idx_admin_role_assign_assignee")
  @@index([is_active], map: "idx_admin_role_assign_active")
  @@map("admin_role_assignments")
}

model ClientModulePermission {
  id         Int      @id @default(autoincrement())
  client_id  String   @db.Uuid
  module_id  Int
  can_view   Boolean  @default(true)
  can_create Boolean  @default(false)
  can_edit   Boolean  @default(false)
  can_delete Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamp(6)
  client     Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  module     Module   @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@unique([client_id, module_id])
  @@index([client_id], map: "idx_client_module_permissions_client")
  @@index([module_id], map: "idx_client_module_permissions_module")
  @@map("client_module_permissions")
}

model ClientUsageEvent {
  id          Int      @id @default(autoincrement())
  client_id   String   @db.Uuid
  module_id   Int?
  user_id     Int?
  event_type  String   @db.VarChar(50)
  meta        Json?
  occurred_at DateTime @default(now()) @db.Timestamp(6)
  client      Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  module      Module?  @relation(fields: [module_id], references: [id])
  user        User?    @relation(fields: [user_id], references: [id])

  @@index([client_id], map: "idx_client_usage_events_client")
  @@index([module_id], map: "idx_client_usage_events_module")
  @@index([occurred_at], map: "idx_client_usage_events_time")
  @@map("client_usage_events")
}

model SystemHealthConfig {
  id                     Int      @id @default(autoincrement())
  thresholds             Json
  backupLocation         String   @db.VarChar(255)
  refreshInterval        Int      @default(30000)
  metricsRetentionDays   Int      @default(7)
  aggregateRetentionDays Int      @default(365)
  updated_at             DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@map("system_health_config")
}

model SystemMetricSample {
  id           Int      @id @default(autoincrement())
  latencyMs    Int
  errorRatePct Float
  reqCount     Int      @default(0)
  errCount     Int      @default(0)
  collected_at DateTime @default(now()) @db.Timestamp(6)

  @@index([collected_at], map: "idx_metric_sample_collected")
  @@map("system_metric_samples")
}

model LoadTestReport {
  id        Int      @id @default(autoincrement())
  source    String   @db.VarChar(100)
  p95Ms     Int
  p99Ms     Int
  avgMs     Int
  errors    Int
  timestamp DateTime @default(now()) @db.Timestamp(6)
  notes     String?  @db.VarChar(500)

  @@index([timestamp], map: "idx_load_test_timestamp")
  @@index([source], map: "idx_load_test_source")
  @@map("load_test_reports")
}

model SystemMetricDailyAggregate {
  id              Int      @id @default(autoincrement())
  day             DateTime @unique
  avgLatencyMs    Int
  avgErrorRatePct Float
  reqCount        Int
  errCount        Int
  created_at      DateTime @default(now()) @db.Timestamp(6)

  @@index([day], map: "idx_metric_daily_day")
  @@map("system_metric_daily")
}

model ClientDailyUsage {
  date         DateTime @db.Date
  client_id    String   @db.Uuid
  module_id    Int
  view_count   Int      @default(0)
  create_count Int      @default(0)
  edit_count   Int      @default(0)
  delete_count Int      @default(0)
  active_users Int      @default(0)
  updated_at   DateTime @default(now()) @updatedAt @db.Timestamp(6)
  client       Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  module       Module   @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@id([date, client_id, module_id])
  @@index([client_id], map: "idx_client_daily_usage_client")
  @@index([module_id], map: "idx_client_daily_usage_module")
  @@map("client_daily_usage")
}

model PaymentRequest {
  id                String                   @id @default(cuid())
  requestId         String                   @unique
  clientId          String?                  @db.Uuid
  clientName        String                   @db.VarChar(200)
  clientEmail       String?                  @db.VarChar(150)
  clientPhone       String?                  @db.VarChar(50)
  subtotal          Decimal                  @db.Decimal(18, 2)
  taxAmount         Decimal                  @default(0) @db.Decimal(18, 2)
  discountAmount    Decimal                  @default(0) @db.Decimal(18, 2)
  totalAmount       Decimal                  @db.Decimal(18, 2)
  currency          String                   @default("INR") @db.VarChar(10)
  description       String?
  notes             String?
  dueDate           DateTime?                @db.Timestamp(6)
  invoiceNumber     String?                  @db.VarChar(100)
  status            String                   @default("DRAFT") @db.VarChar(50)
  attachments       Json?
  paymentToken      String?                  @unique
  paymentLinkSentAt DateTime?                @db.Timestamp(6)
  createdById       Int
  createdAt         DateTime                 @default(now()) @db.Timestamp(6)
  updatedAt         DateTime                 @default(now()) @updatedAt @db.Timestamp(6)
  expense           Expense?
  activityLogs      PaymentActivityLog[]
  lineItems         PaymentRequestLineItem[]
  client            Client?                  @relation("ClientPaymentRequests", fields: [clientId], references: [id])
  createdBy         User                     @relation("PaymentRequestCreator", fields: [createdById], references: [id])
  task              Task?

  @@index([requestId], map: "idx_payment_requests_request_id")
  @@index([clientId], map: "idx_payment_requests_client")
  @@index([status], map: "idx_payment_requests_status")
  @@index([createdById], map: "idx_payment_requests_creator")
  @@index([paymentToken], map: "idx_payment_requests_token")
  @@map("payment_requests")
}

model PaymentRequestLineItem {
  id               Int            @id @default(autoincrement())
  paymentRequestId String
  description      String         @db.VarChar(500)
  quantity         Decimal        @default(1) @db.Decimal(10, 2)
  unit             String?        @default("unit") @db.VarChar(50)
  rate             Decimal        @db.Decimal(18, 2)
  taxRate          Decimal        @default(0) @db.Decimal(5, 2)
  discountRate     Decimal        @default(0) @db.Decimal(5, 2)
  lineTotal        Decimal        @db.Decimal(18, 2)
  sortOrder        Int            @default(0)
  paymentRequest   PaymentRequest @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)

  @@index([paymentRequestId], map: "idx_line_items_payment_request")
  @@map("payment_request_line_items")
}

model Expense {
  id               String         @id @default(cuid())
  requestId        String         @unique
  paymentRequestId String         @unique
  createdById      Int
  clientId         String?        @db.Uuid
  description      String?
  amount           Decimal        @db.Decimal(18, 2)
  currency         String         @default("INR") @db.VarChar(10)
  dueDate          DateTime?      @db.Timestamp(6)
  status           String         @default("DRAFT") @db.VarChar(50)
  attachments      Json?
  createdAt        DateTime       @default(now()) @db.Timestamp(6)
  updatedAt        DateTime       @default(now()) @updatedAt @db.Timestamp(6)
  createdBy        User           @relation("ExpenseCreator", fields: [createdById], references: [id])
  paymentRequest   PaymentRequest @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)
  task             Task?

  @@index([requestId], map: "idx_expenses_request_id")
  @@index([paymentRequestId], map: "idx_expenses_payment_request")
  @@index([createdById], map: "idx_expenses_creator")
  @@index([status], map: "idx_expenses_status")
  @@map("expenses")
}

model Task {
  id                    String                 @id @default(cuid())
  expenseId             String                 @unique
  paymentRequestId      String                 @unique
  title                 String                 @db.VarChar(300)
  description           String?
  currentLevel          Int                    @default(0)
  status                String                 @default("PENDING") @db.VarChar(50)
  createdById           Int
  assigneeId            Int?
  billId                String?
  createdAt             DateTime               @default(now()) @db.Timestamp(6)
  updatedAt             DateTime               @default(now()) @updatedAt @db.Timestamp(6)
  approvals             Approval[]
  approverSelectionLogs ApproverSelectionLog[] @relation("ApproverSelectionLogs")
  bill                  Bill?                  @relation("BillTask")
  messages              Message[]
  paymentRecords        PaymentRecord[]
  assignee              User?                  @relation("TaskAssignee", fields: [assigneeId], references: [id])
  createdBy             User                   @relation("TaskCreator", fields: [createdById], references: [id])
  expense               Expense                @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  paymentRequest        PaymentRequest         @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)

  @@index([expenseId], map: "idx_tasks_expense")
  @@index([paymentRequestId], map: "idx_tasks_payment_request")
  @@index([assigneeId], map: "idx_tasks_assignee")
  @@index([status], map: "idx_tasks_status")
  @@index([currentLevel], map: "idx_tasks_level")
  @@map("tasks")
}

model Approval {
  id          String   @id @default(cuid())
  taskId      String
  level       Int
  levelName   String   @db.VarChar(100)
  approverId  Int
  action      String   @db.VarChar(50)
  comment     String?
  attachments Json?
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  approver    User     @relation("TaskApprovals", fields: [approverId], references: [id])
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId], map: "idx_approvals_task")
  @@index([approverId], map: "idx_approvals_approver")
  @@index([level], map: "idx_approvals_level")
  @@map("approvals")
}

model Message {
  id          String   @id @default(cuid())
  taskId      String
  senderId    Int
  body        String?
  attachments Json?
  type        String   @default("TEXT") @db.VarChar(50)
  meta        Json?
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  sender      User     @relation("TaskMessages", fields: [senderId], references: [id])
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId], map: "idx_messages_task")
  @@index([senderId], map: "idx_messages_sender")
  @@index([type], map: "idx_messages_type")
  @@map("messages")
}

model PaymentRecord {
  id               String    @id @default(cuid())
  taskId           String
  paymentRequestId String
  paidById         Int?
  paymentMode      String?   @db.VarChar(100)
  paymentGateway   String?   @db.VarChar(100)
  transactionId    String?   @db.VarChar(255)
  details          Json?
  amount           Decimal   @db.Decimal(18, 2)
  currency         String    @default("INR") @db.VarChar(10)
  paidAt           DateTime? @db.Timestamp(6)
  receiptUrl       String?
  notes            String?
  createdAt        DateTime  @default(now()) @db.Timestamp(6)
  paidBy           User?     @relation("PaymentRecords", fields: [paidById], references: [id])
  task             Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId], map: "idx_payment_records_task")
  @@index([paymentRequestId], map: "idx_payment_records_payment_request")
  @@index([paidById], map: "idx_payment_records_paid_by")
  @@index([transactionId], map: "idx_payment_records_transaction")
  @@map("payment_records")
}

model ApprovalLevel {
  id            Int      @id @default(autoincrement())
  level         Int      @unique
  levelName     String   @db.VarChar(100)
  roleName      String   @db.VarChar(100)
  sortOrder     Int      @default(0)
  isActive      Boolean  @default(true)
  approvalLimit Decimal? @db.Decimal(15, 2)
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@index([level], map: "idx_approval_levels_level")
  @@map("approval_levels")
}

model ApproverConfiguration {
  id                 String   @id @default(cuid())
  userId             Int
  level              Int
  approvalLimit      Decimal? @db.Decimal(15, 2)
  isActive           Boolean  @default(true)
  isAvailable        Boolean  @default(true)
  autoAssign         Boolean  @default(true)
  priority           Int      @default(0)
  maxConcurrentTasks Int?     @default(10)
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  updatedAt          DateTime @default(now()) @updatedAt @db.Timestamp(6)
  user               User     @relation("ApproverConfigurations", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, level])
  @@index([userId], map: "idx_approver_config_user")
  @@index([level, isActive], map: "idx_approver_config_level_active")
  @@index([isActive, isAvailable], map: "idx_approver_config_availability")
  @@map("approver_configurations")
}

model ApproverSelectionLog {
  id                 String   @id @default(cuid())
  taskId             String?
  paymentRequestId   String?
  level              Int
  selectedApproverId Int
  requestedApprovers Json?
  availableApprovers Json?
  selectionMethod    String   @db.VarChar(50)
  paymentAmount      Decimal? @db.Decimal(15, 2)
  approverWorkload   Int?
  metadata           Json?
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  selectedApprover   User     @relation("ApproverSelectionLogs", fields: [selectedApproverId], references: [id], onDelete: Cascade)
  task               Task?    @relation("ApproverSelectionLogs", fields: [taskId], references: [id])

  @@index([taskId], map: "idx_selection_log_task")
  @@index([selectedApproverId], map: "idx_selection_log_approver")
  @@index([level, createdAt], map: "idx_selection_log_level_created")
  @@map("approver_selection_logs")
}

model PaymentActivityLog {
  id               Int            @id @default(autoincrement())
  paymentRequestId String
  userId           Int?
  action           String         @db.VarChar(100)
  oldStatus        String?        @db.VarChar(50)
  newStatus        String?        @db.VarChar(50)
  comment          String?
  metadata         Json?
  createdAt        DateTime       @default(now()) @db.Timestamp(6)
  paymentRequest   PaymentRequest @relation(fields: [paymentRequestId], references: [id], onDelete: Cascade)
  user             User?          @relation("PaymentActivityLogs", fields: [userId], references: [id])

  @@index([paymentRequestId], map: "idx_activity_logs_payment_request")
  @@index([userId], map: "idx_activity_logs_user")
  @@index([action], map: "idx_activity_logs_action")
  @@map("payment_activity_logs")
}

model OtpToken {
  id            String    @id @default(cuid())
  email         String    @db.VarChar(150)
  purpose       String    @db.VarChar(50)
  otp_hash      String    @db.VarChar(128)
  expires_at    DateTime  @db.Timestamp(6)
  attempts      Int       @default(0)
  verified      Boolean   @default(false)
  ip_address    String?   @db.Inet
  user_agent    String?
  created_at    DateTime  @default(now()) @db.Timestamp(6)
  last_sent_at  DateTime  @default(now()) @db.Timestamp(6)
  blocked_until DateTime?

  @@index([email], map: "idx_otp_email")
  @@index([purpose], map: "idx_otp_purpose")
  @@index([expires_at], map: "idx_otp_expires")
  @@index([created_at], map: "idx_otp_created")
  @@map("otp_tokens")
}

model Thread {
  id          String          @id @default(cuid())
  title       String?         @db.VarChar(200)
  createdById Int
  createdAt   DateTime        @default(now()) @db.Timestamp(6)
  updatedAt   DateTime        @default(now()) @updatedAt @db.Timestamp(6)
  callLogs    CallLog[]
  members     ThreadMember[]
  messages    ThreadMessage[]
  createdBy   User            @relation("ThreadCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById], map: "idx_threads_creator")
  @@map("threads")
}

model ThreadMember {
  id       String    @id @default(cuid())
  threadId String
  userId   Int
  role     String    @default("member") @db.VarChar(50)
  joinedAt DateTime  @default(now()) @db.Timestamp(6)
  leftAt   DateTime?
  isActive Boolean   @default(true)
  thread   Thread    @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user     User      @relation("ThreadMemberUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
  @@index([userId], map: "idx_thread_members_user")
  @@index([threadId], map: "idx_thread_members_thread")
  @@index([role], map: "idx_thread_members_role")
  @@map("thread_members")
}

model CallLog {
  id               String    @id @default(cuid())
  room_name        String    @db.VarChar(255)
  thread_id        String
  initiator_id     Int
  call_type        String    @default("audio") @db.VarChar(20)
  status           String    @default("ringing") @db.VarChar(30)
  started_at       DateTime  @default(now()) @db.Timestamp(6)
  ended_at         DateTime?
  duration_seconds Int?      @default(0)
  participants     Json?
  recording_url    String?
  transcript_url   String?
  quality_metrics  Json?
  consent_recorded Boolean   @default(false)
  created_at       DateTime  @default(now()) @db.Timestamp(6)
  updated_at       DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  initiator        User      @relation("CallLogInitiator", fields: [initiator_id], references: [id], onDelete: SetNull)
  thread           Thread    @relation(fields: [thread_id], references: [id], onDelete: Cascade)

  @@index([thread_id], map: "idx_call_logs_thread")
  @@index([initiator_id], map: "idx_call_logs_initiator")
  @@index([room_name], map: "idx_call_logs_room")
  @@index([status], map: "idx_call_logs_status")
  @@index([started_at], map: "idx_call_logs_started")
  @@map("call_logs")
}

model ThreadMessage {
  id          String          @id @default(cuid())
  threadId    String
  senderId    Int
  content     String
  type        String          @default("text") @db.VarChar(50)
  attachments Json?
  replyToId   String?
  reactions   Json?
  isEdited    Boolean         @default(false)
  editedAt    DateTime?       @db.Timestamp(6)
  isDeleted   Boolean         @default(false)
  deletedAt   DateTime?       @db.Timestamp(6)
  readBy      Json?
  createdAt   DateTime        @default(now()) @db.Timestamp(6)
  updatedAt   DateTime        @default(now()) @updatedAt @db.Timestamp(6)
  replyTo     ThreadMessage?  @relation("MessageReplies", fields: [replyToId], references: [id])
  replies     ThreadMessage[] @relation("MessageReplies")
  sender      User            @relation("ThreadMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  thread      Thread          @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId], map: "idx_thread_messages_thread")
  @@index([senderId], map: "idx_thread_messages_sender")
  @@index([createdAt], map: "idx_thread_messages_created")
  @@index([type], map: "idx_thread_messages_type")
  @@index([isDeleted], map: "idx_thread_messages_deleted")
  @@map("thread_messages")
}

model AssistantMemory {
  id                String   @id @default(cuid())
  userId            Int      @unique
  lastBranchId      Int?
  lastModule        String?  @db.VarChar(100)
  preferences       Json?
  lastSummary       String?
  conversationCount Int      @default(0)
  createdAt         DateTime @default(now()) @db.Timestamp(6)
  updatedAt         DateTime @default(now()) @updatedAt @db.Timestamp(6)
  user              User     @relation("AssistantMemoryUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_assistant_memory_user")
  @@index([lastModule], map: "idx_assistant_memory_module")
  @@map("assistant_memory")
}

model Bill {
  id              String    @id @default(cuid())
  filePath        String    @db.VarChar(500)
  originalName    String    @db.VarChar(255)
  fileType        String    @db.VarChar(50)
  fileSize        Int
  uploadedById    Int
  ocrStatus       OcrStatus @default(PENDING)
  ocrText         String?
  parsedJson      Json?
  taskId          String?   @unique
  taskCreated     Boolean   @default(false)
  processingError String?
  processingTime  Int?      @default(0)
  confidence      Float?
  createdAt       DateTime  @default(now()) @db.Timestamp(6)
  updatedAt       DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  task            Task?     @relation("BillTask", fields: [taskId], references: [id])
  uploadedBy      User      @relation("BillUploader", fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([uploadedById], map: "idx_bills_uploader")
  @@index([ocrStatus], map: "idx_bills_ocr_status")
  @@index([taskCreated], map: "idx_bills_task_created")
  @@index([createdAt(sort: Desc)], map: "idx_bills_created")
  @@map("bills")
}

model RateLimitViolation {
  id              Int      @id @default(autoincrement())
  ip_address      String   @db.VarChar(45)
  endpoint        String   @db.VarChar(255)
  user_agent      String?
  violation_type  String   @default("UNKNOWN") @db.VarChar(50)
  timestamp       DateTime @default(now()) @db.Timestamp(6)
  country_code    String?  @db.VarChar(2)
  user_id         Int?
  request_method  String?  @db.VarChar(10)
  response_status Int      @default(429)

  @@index([ip_address, timestamp], map: "idx_violations_ip_timestamp")
  @@index([endpoint, timestamp], map: "idx_violations_endpoint_timestamp")
  @@index([timestamp(sort: Desc)], map: "idx_violations_timestamp")
  @@index([violation_type], map: "idx_violations_type")
  @@map("rate_limit_violations")
}

model UserProfile {
  id             Int            @id @default(autoincrement())
  userId         Int            @unique @map("user_id")
  fullName       String?        @map("full_name") @db.VarChar(255)
  employeeCode   String?        @unique @map("employee_code") @db.VarChar(50)
  phone          String?        @db.VarChar(20)
  alternatePhone String?        @map("alternate_phone") @db.VarChar(20)
  dateOfBirth    DateTime?      @map("date_of_birth") @db.Date
  gender         Gender?
  bloodGroup     String?        @map("blood_group") @db.VarChar(10)
  profilePicUrl  String?        @map("profile_pic_url")
  fatherName     String?        @map("father_name") @db.VarChar(255)
  motherName     String?        @map("mother_name") @db.VarChar(255)
  maritalStatus  MaritalStatus? @map("marital_status")
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime       @updatedAt @map("updated_at") @db.Timestamp(6)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([employeeCode])
  @@map("user_profiles")
}

model UserAddress {
  id         Int         @id @default(autoincrement())
  userId     Int         @map("user_id")
  type       AddressType
  line1      String      @db.VarChar(255)
  line2      String?     @db.VarChar(255)
  city       String      @db.VarChar(100)
  state      String      @db.VarChar(100)
  postalCode String      @map("postal_code") @db.VarChar(20)
  country    String      @default("India") @db.VarChar(100)
  isDefault  Boolean     @default(false) @map("is_default")
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt  DateTime    @updatedAt @map("updated_at") @db.Timestamp(6)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@map("user_addresses")
}

model UserKYC {
  id                 Int       @id @default(autoincrement())
  userId             Int       @unique @map("user_id")
  // DEPRECATED: Use encrypted fields below
  panNumber          String?   @map("pan_number") @db.VarChar(20)
  aadhaarNumber      String?   @map("aadhaar_number") @db.VarChar(20)
  // Encrypted PII fields (AES-256-GCM)
  panEncrypted       Bytes?    @map("pan_encrypted")
  panIv              Bytes?    @map("pan_iv")
  panLast4           String?   @map("pan_last4") @db.VarChar(4)
  aadhaarEncrypted   Bytes?    @map("aadhaar_encrypted")
  aadhaarIv          Bytes?    @map("aadhaar_iv")
  aadhaarLast4       String?   @map("aadhaar_last4") @db.VarChar(4)
  encryptionVersion  Int       @default(1) @map("encryption_version")
  kycStatus          KYCStatus @default(PENDING) @map("kyc_status")
  panDocumentUrl     String?   @map("pan_document_url")
  aadhaarDocumentUrl String?   @map("aadhaar_document_url")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([kycStatus])
  @@map("user_kyc")
}

model UserBankAccount {
  id                         Int      @id @default(autoincrement())
  userId                     Int      @map("user_id")
  accountHolderName          String   @map("account_holder_name") @db.VarChar(255)
  bankName                   String   @map("bank_name") @db.VarChar(255)
  branchName                 String   @map("branch_name") @db.VarChar(255)
  // DEPRECATED: Use encrypted field below
  accountNumber              String   @map("account_number") @db.VarChar(50)
  // Encrypted account number (AES-256-GCM)
  accountNumberEncrypted     Bytes?   @map("account_number_encrypted")
  accountNumberIv            Bytes?   @map("account_number_iv")
  accountNumberLast4         String?  @map("account_number_last4") @db.VarChar(4)
  encryptionVersion          Int      @default(1) @map("encryption_version")
  ifscCode                   String   @map("ifsc_code") @db.VarChar(20)
  isPrimary                  Boolean  @default(false) @map("is_primary")
  cancelledChequeDocumentUrl String?  @map("cancelled_cheque_document_url")
  createdAt                  DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt                  DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  user                       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isPrimary])
  @@map("user_bank_accounts")
}

model UserEducation {
  id                Int      @id @default(autoincrement())
  userId            Int      @map("user_id")
  degree            String   @db.VarChar(255)
  institutionName   String   @map("institution_name") @db.VarChar(255)
  yearOfPassing     Int      @map("year_of_passing")
  gradeOrPercentage String   @map("grade_or_percentage") @db.VarChar(50)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_education")
}

model UserSkill {
  id               Int              @id @default(autoincrement())
  userId           Int              @map("user_id")
  skillName        String           @map("skill_name") @db.VarChar(255)
  proficiencyLevel ProficiencyLevel @map("proficiency_level")
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime         @updatedAt @map("updated_at") @db.Timestamp(6)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_skills")
}

model UserAchievement {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  title           String   @db.VarChar(255)
  description     String?
  achievementDate DateTime @map("achievement_date") @db.Date
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_achievements")
}

model UserEmergencyContact {
  id             Int      @id @default(autoincrement())
  userId         Int      @map("user_id")
  name           String   @db.VarChar(255)
  relationship   String   @db.VarChar(100)
  phone          String   @db.VarChar(20)
  alternatePhone String?  @map("alternate_phone") @db.VarChar(20)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_emergency_contacts")
}

model Branch {
  id           Int          @id @default(autoincrement())
  tenantId     String?      @map("tenant_id") @db.Uuid
  branchCode   String       @unique @map("branch_code") @db.VarChar(50)
  branchName   String       @map("branch_name") @db.VarChar(255)
  addressLine1 String       @map("address_line1") @db.VarChar(255)
  addressLine2 String?      @map("address_line2") @db.VarChar(255)
  city         String       @db.VarChar(100)
  state        String       @db.VarChar(100)
  postalCode   String       @map("postal_code") @db.VarChar(20)
  country      String       @default("India") @db.VarChar(100)
  isActive     Boolean      @default(true) @map("is_active")
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamp(6)
  client       Client?      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userBranches UserBranch[]

  @@index([tenantId])
  @@index([branchCode])
  @@map("branches")
}

model UserBranch {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  branchId  Int      @map("branch_id")
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, branchId])
  @@index([userId])
  @@index([branchId])
  @@map("user_branches")
}

model ClientToClientSequence {
  A                String         @db.Uuid
  B                Int
  clients          Client         @relation(fields: [A], references: [id], onDelete: Cascade)
  client_sequences ClientSequence @relation(fields: [B], references: [id], onDelete: Cascade)

  @@id([A, B], map: "_ClientToClientSequence_AB_pkey")
  @@index([B], map: "_ClientToClientSequence_B_index")
  @@map("_ClientToClientSequence")
}

enum OcrStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

enum AddressType {
  PERMANENT
  OFFICE
  HOME
  CORRESPONDENCE
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum KYCStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum ProficiencyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

// ============================================================================
// TENANT USAGE & QUOTAS
// ============================================================================

/// Daily usage metrics per tenant for billing and analytics
model TenantUsage {
  id           Int      @id @default(autoincrement())
  tenantId     String   @map("tenant_id") @db.Uuid
  date         DateTime @db.Date
  apiCalls     Int      @default(0) @map("api_calls")
  storageBytes BigInt   @default(0) @map("storage_bytes")
  activeUsers  Int      @default(0) @map("active_users")

  /// JSONB for tracking feature-specific usage
  featureUsage Json? @default("{}") @map("feature_usage")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, date], name: "tenant_usage_tenant_date_unique")
  @@index([tenantId])
  @@index([date])
  @@index([tenantId, date])
  @@map("tenant_usage")
}

/// Per-tenant quota configuration and limits
model TenantQuota {
  id       Int    @id @default(autoincrement())
  tenantId String @unique @map("tenant_id") @db.Uuid
  plan     String @default("free") @db.VarChar(50)

  /// Rate limits
  apiCallsPerMinute Int @default(60) @map("api_calls_per_minute")
  apiCallsPerDay    Int @default(5000) @map("api_calls_per_day")

  /// Resource limits
  storageBytesLimit BigInt @default(1073741824) @map("storage_bytes_limit") // 1GB
  activeUsersLimit  Int    @default(5) @map("active_users_limit")

  /// Feature flags
  features Json? @default("{}")

  /// Override settings
  isUnlimited  Boolean @default(false) @map("is_unlimited")
  customLimits Json?   @map("custom_limits")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([plan])
  @@map("tenant_quotas")
}

/// Plan definitions with default quota values
model QuotaPlan {
  plan              String   @id @db.VarChar(50)
  displayName       String   @map("display_name") @db.VarChar(100)
  apiCallsPerMinute Int      @map("api_calls_per_minute")
  apiCallsPerDay    Int      @map("api_calls_per_day")
  storageBytesLimit BigInt   @map("storage_bytes_limit")
  activeUsersLimit  Int      @map("active_users_limit")
  features          Json?    @default("{}")
  createdAt         DateTime @default(now()) @map("created_at")

  @@map("quota_plans")
}

/// Events table for analytics telemetry
model Event {
  id        Int      @id @default(autoincrement())
  clientId  String?  @map("client_id") @db.Uuid
  userId    Int?     @map("user_id")
  eventType String   @map("event_type") @db.VarChar(100)
  payload   Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  client Client? @relation("ClientEvents", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, createdAt], map: "idx_events_client_created")
  @@index([eventType], map: "idx_events_type")
  @@index([createdAt], map: "idx_events_created")
  @@index([clientId, eventType], map: "idx_events_client_type")
  @@map("events")
}

/// Billing profile for each tenant/client
model BillingProfile {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId            String   @unique @map("client_id") @db.Uuid
  
  /// Stripe integration
  stripeCustomerId    String?  @unique @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId String? @map("stripe_subscription_id") @db.VarChar(255)
  stripePriceId       String?  @map("stripe_price_id") @db.VarChar(255)
  
  /// Plan details
  plan                String   @default("free") @db.VarChar(50)
  billingCycle        String   @default("monthly") @map("billing_cycle") @db.VarChar(20)
  status              String   @default("active") @db.VarChar(30)
  
  /// Trial management
  trialStartDate      DateTime? @map("trial_start_date") @db.Timestamp(6)
  trialEndDate        DateTime? @map("trial_end_date") @db.Timestamp(6)
  trialExtended       Boolean  @default(false) @map("trial_extended")
  trialExtensionDays  Int      @default(0) @map("trial_extension_days")
  
  /// Payment method (stored in Stripe, reference only)
  paymentMethodId     String?  @map("payment_method_id") @db.VarChar(255)
  cardLast4           String?  @map("card_last_4") @db.VarChar(4)
  cardBrand           String?  @map("card_brand") @db.VarChar(50)
  cardExpMonth        Int?     @map("card_exp_month")
  cardExpYear         Int?     @map("card_exp_year")
  
  /// Billing address
  billingName         String?  @map("billing_name") @db.VarChar(200)
  billingEmail        String?  @map("billing_email") @db.VarChar(255)
  billingAddress      Json?    @map("billing_address")
  
  /// Tax information
  taxId               String?  @map("tax_id") @db.VarChar(100)
  taxIdType           String?  @map("tax_id_type") @db.VarChar(50)
  taxExempt           Boolean  @default(false) @map("tax_exempt")
  
  /// Balance and credits
  balance             Decimal  @default(0) @db.Decimal(12, 2)
  creditBalance       Decimal  @default(0) @map("credit_balance") @db.Decimal(12, 2)
  
  /// Billing dates
  currentPeriodStart  DateTime? @map("current_period_start") @db.Timestamp(6)
  currentPeriodEnd    DateTime? @map("current_period_end") @db.Timestamp(6)
  nextBillingDate     DateTime? @map("next_billing_date") @db.Timestamp(6)
  cancelAtPeriodEnd   Boolean  @default(false) @map("cancel_at_period_end")
  canceledAt          DateTime? @map("canceled_at") @db.Timestamp(6)
  
  /// Audit
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  
  /// Relations
  invoices            Invoice[]
  usageRecords        UsageRecord[]
  webhookEvents       BillingWebhookEvent[]
  
  @@index([stripeCustomerId], map: "idx_billing_profiles_stripe_customer")
  @@index([stripeSubscriptionId], map: "idx_billing_profiles_stripe_subscription")
  @@index([status], map: "idx_billing_profiles_status")
  @@index([plan], map: "idx_billing_profiles_plan")
  @@map("billing_profiles")
}

/// Invoices for billing
model Invoice {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  billingProfileId    String   @map("billing_profile_id") @db.Uuid
  
  /// Stripe reference
  stripeInvoiceId     String?  @unique @map("stripe_invoice_id") @db.VarChar(255)
  stripeInvoiceUrl    String?  @map("stripe_invoice_url")
  stripePdfUrl        String?  @map("stripe_pdf_url")
  stripeHostedUrl     String?  @map("stripe_hosted_url")
  
  /// Invoice details
  invoiceNumber       String   @unique @map("invoice_number") @db.VarChar(50)
  status              String   @default("draft") @db.VarChar(30)
  currency            String   @default("USD") @db.VarChar(3)
  
  /// Amounts
  subtotal            Decimal  @db.Decimal(12, 2)
  tax                 Decimal  @default(0) @db.Decimal(12, 2)
  discount            Decimal  @default(0) @db.Decimal(12, 2)
  total               Decimal  @db.Decimal(12, 2)
  amountPaid          Decimal  @default(0) @map("amount_paid") @db.Decimal(12, 2)
  amountDue           Decimal  @map("amount_due") @db.Decimal(12, 2)
  
  /// Line items (JSON array of items)
  lineItems           Json     @default("[]") @map("line_items")
  
  /// Dates
  invoiceDate         DateTime @map("invoice_date") @db.Timestamp(6)
  dueDate             DateTime? @map("due_date") @db.Timestamp(6)
  paidAt              DateTime? @map("paid_at") @db.Timestamp(6)
  voidedAt            DateTime? @map("voided_at") @db.Timestamp(6)
  
  /// Period
  periodStart         DateTime? @map("period_start") @db.Timestamp(6)
  periodEnd           DateTime? @map("period_end") @db.Timestamp(6)
  
  /// Metadata
  description         String?
  notes               String?
  metadata            Json?    @default("{}")
  
  /// Audit
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  
  /// Relations
  billingProfile      BillingProfile @relation(fields: [billingProfileId], references: [id], onDelete: Cascade)
  payments            Payment[]
  
  @@index([billingProfileId], map: "idx_invoices_billing_profile")
  @@index([status], map: "idx_invoices_status")
  @@index([invoiceDate], map: "idx_invoices_date")
  @@index([stripeInvoiceId], map: "idx_invoices_stripe")
  @@map("invoices")
}

/// Payment records for invoices
model Payment {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceId           String   @map("invoice_id") @db.Uuid
  
  /// Stripe reference
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id") @db.VarChar(255)
  stripeChargeId      String?  @map("stripe_charge_id") @db.VarChar(255)
  
  /// Payment details
  amount              Decimal  @db.Decimal(12, 2)
  currency            String   @default("USD") @db.VarChar(3)
  status              String   @default("pending") @db.VarChar(30)
  paymentMethod       String?  @map("payment_method") @db.VarChar(50)
  
  /// Card info (if applicable)
  cardLast4           String?  @map("card_last_4") @db.VarChar(4)
  cardBrand           String?  @map("card_brand") @db.VarChar(50)
  
  /// Failure info
  failureCode         String?  @map("failure_code") @db.VarChar(100)
  failureMessage      String?  @map("failure_message")
  
  /// Dates
  paidAt              DateTime? @map("paid_at") @db.Timestamp(6)
  refundedAt          DateTime? @map("refunded_at") @db.Timestamp(6)
  
  /// Audit
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  
  /// Relations
  invoice             Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId], map: "idx_payments_invoice")
  @@index([status], map: "idx_payments_status")
  @@index([stripePaymentIntentId], map: "idx_payments_stripe")
  @@map("payments")
}

/// Usage records for billing (aggregated from ClientUsageEvent)
model UsageRecord {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  billingProfileId    String   @map("billing_profile_id") @db.Uuid
  
  /// Usage type
  usageType           String   @map("usage_type") @db.VarChar(50)
  
  /// Period
  periodStart         DateTime @map("period_start") @db.Timestamp(6)
  periodEnd           DateTime @map("period_end") @db.Timestamp(6)
  
  /// Quantities
  quantity            BigInt   @default(0)
  includedQuantity    BigInt   @default(0) @map("included_quantity")
  overageQuantity     BigInt   @default(0) @map("overage_quantity")
  
  /// Pricing
  unitPrice           Decimal  @default(0) @map("unit_price") @db.Decimal(10, 6)
  overagePrice        Decimal  @default(0) @map("overage_price") @db.Decimal(10, 6)
  totalAmount         Decimal  @default(0) @map("total_amount") @db.Decimal(12, 2)
  
  /// Metadata
  metadata            Json?    @default("{}")
  
  /// Audit
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  
  /// Relations
  billingProfile      BillingProfile @relation(fields: [billingProfileId], references: [id], onDelete: Cascade)
  
  @@unique([billingProfileId, usageType, periodStart, periodEnd], map: "uniq_usage_record_period")
  @@index([billingProfileId], map: "idx_usage_records_billing_profile")
  @@index([usageType], map: "idx_usage_records_type")
  @@index([periodStart, periodEnd], map: "idx_usage_records_period")
  @@map("usage_records")
}

/// Webhook events from Stripe for audit trail
model BillingWebhookEvent {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  billingProfileId    String?  @map("billing_profile_id") @db.Uuid
  
  /// Stripe event details
  stripeEventId       String   @unique @map("stripe_event_id") @db.VarChar(255)
  eventType           String   @map("event_type") @db.VarChar(100)
  
  /// Event data
  payload             Json     @default("{}")
  
  /// Processing status
  status              String   @default("received") @db.VarChar(30)
  processedAt         DateTime? @map("processed_at") @db.Timestamp(6)
  error               String?
  retryCount          Int      @default(0) @map("retry_count")
  
  /// Audit
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  
  /// Relations
  billingProfile      BillingProfile? @relation(fields: [billingProfileId], references: [id], onDelete: SetNull)
  
  @@index([stripeEventId], map: "idx_billing_webhook_stripe_event")
  @@index([eventType], map: "idx_billing_webhook_type")
  @@index([status], map: "idx_billing_webhook_status")
  @@index([createdAt], map: "idx_billing_webhook_created")
  @@map("billing_webhook_events")
}
