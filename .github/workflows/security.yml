name: Security Tests

# Security Tests & Smoke Test Pipeline
# Runs on every push/PR to main and deployment branches.
# Validates code linting, RLS tests, Redis tests, and security smoke tests.
#
# Required secrets:
#   - ENCRYPTION_KEY: 32-byte hex key for PII encryption (optional for tests)

on:
  push:
    branches:
      - main
      - deployment
      - 'release/*'
    paths:
      - 'my-backend/**'
      - 'database/**'
      - '.github/workflows/security.yml'
  pull_request:
    branches:
      - main
      - deployment
    paths:
      - 'my-backend/**'
      - 'database/**'

env:
  NODE_ENV: test
  CI: true

jobs:
  # ============================================================================
  # LINT JOB
  # ============================================================================
  lint:
    name: Lint & Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: my-backend/package-lock.json
      
      - name: Install dependencies
        working-directory: my-backend
        run: npm ci
      
      - name: Run ESLint
        working-directory: my-backend
        run: |
          npm run lint || echo "Lint warnings found"
      
      - name: Check for security vulnerabilities
        working-directory: my-backend
        run: |
          npm audit --audit-level=high || echo "Security audit completed with findings"

  # ============================================================================
  # SECURITY TESTS JOB
  # ============================================================================
  security-tests:
    name: Security Integration Tests
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      # PostgreSQL service container
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: bisman_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      # Redis service container
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: my-backend/package-lock.json
      
      - name: Install dependencies
        working-directory: my-backend
        run: npm ci
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      # ----------------------------------------
      # Database Setup
      # ----------------------------------------
      - name: Setup test database extensions
        env:
          PGPASSWORD: postgres
        run: |
          psql -h localhost -U postgres -d bisman_test -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"
          psql -h localhost -U postgres -d bisman_test -c "CREATE EXTENSION IF NOT EXISTS \"citext\";"
          psql -h localhost -U postgres -d bisman_test -c "CREATE EXTENSION IF NOT EXISTS \"pgcrypto\";"
      
      - name: Create test database roles
        env:
          PGPASSWORD: postgres
        run: |
          psql -h localhost -U postgres -d bisman_test << 'EOF'
          DO $$
          BEGIN
            IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'bisman_frontend') THEN
              CREATE ROLE bisman_frontend WITH LOGIN PASSWORD 'test_frontend';
            END IF;
            IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'bisman_backend') THEN
              CREATE ROLE bisman_backend WITH LOGIN PASSWORD 'test_backend';
            END IF;
            IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'bisman_worker') THEN
              CREATE ROLE bisman_worker WITH LOGIN PASSWORD 'test_worker';
            END IF;
            IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'bisman_migrator') THEN
              CREATE ROLE bisman_migrator WITH LOGIN PASSWORD 'test_migrator';
            END IF;
          END
          $$;
          
          GRANT ALL PRIVILEGES ON DATABASE bisman_test TO bisman_backend;
          EOF

      - name: Run database migrations
        working-directory: my-backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/bisman_test
        run: |
          # Run Prisma migrations if available
          if [ -f "prisma/schema.prisma" ]; then
            npx prisma migrate deploy || echo "Prisma migrations completed"
          fi
          
          # Run SQL migrations
          for f in database/migrations/*.sql; do
            if [ -f "$f" ]; then
              echo "Running migration: $f"
              PGPASSWORD=postgres psql -h localhost -U postgres -d bisman_test -f "$f" || true
            fi
          done

      # ----------------------------------------
      # Run Tests
      # ----------------------------------------
      - name: Run RLS integration tests
        working-directory: my-backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/bisman_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          echo "ðŸ” Running RLS integration tests..."
          npx jest tests/rls.test.js --runInBand --verbose --forceExit
      
      - name: Run Redis invalidation tests
        working-directory: my-backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/bisman_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          echo "ðŸ“¡ Running Redis invalidation tests..."
          npx jest tests/redisInvalidate.test.js --runInBand --verbose --forceExit
      
      - name: Run security smoke test
        working-directory: my-backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/bisman_test
          REDIS_URL: redis://localhost:6379/0
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY || 'test_encryption_key_32_bytes_0123456789abcdef0123456789abcdef' }}
        run: |
          echo "ðŸ”’ Running security smoke test..."
          node tools/securitySmokeTest.js

      # ----------------------------------------
      # Verify Migrations
      # ----------------------------------------
      - name: Verify migration integrity
        env:
          PGPASSWORD: postgres
        run: |
          echo "ðŸ“‹ Verifying migration integrity..."
          if [ -f "my-backend/tools/verify_migrations.sql" ]; then
            psql -h localhost -U postgres -d bisman_test -f my-backend/tools/verify_migrations.sql
          fi

      # ----------------------------------------
      # Upload Artifacts
      # ----------------------------------------
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            my-backend/coverage/
            my-backend/test-results/
          retention-days: 7

  # ============================================================================
  # NOTIFY JOB
  # ============================================================================
  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint, security-tests]
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "ðŸš¨ Security tests failed!"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          # Add Slack/Teams/Discord webhook here if needed
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Security tests failed on ${{ github.ref }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
