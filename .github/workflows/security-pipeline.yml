name: Security Pipeline
'on':
  push:
    branches: [main, deployment, staging]
  pull_request:
    branches: [main, deployment, staging]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18.x'

jobs:
  # ============================================================================
  # JOB 1: SECRET SCANNING
  # ============================================================================
  secret-scan:
    name: üîç Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: GitLeaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # JOB 2: DEPENDENCY SCANNING
  # ============================================================================
  dependency-scan:
    name: üì¶ Dependency Security Audit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: ['my-backend', 'my-frontend']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ matrix.directory }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.directory }}
        run: npm ci

      - name: Run npm audit
        working-directory: ${{ matrix.directory }}
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > npm-audit-${{ matrix.directory }}.json || true

      - name: Upload npm audit results
        uses: actions/upload-artifact@v3
        with:
          name: npm-audit-${{ matrix.directory }}
          path: ${{ matrix.directory }}/npm-audit-${{ matrix.directory }}.json

      - name: Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=${{ matrix.directory }}/package.json

  # ============================================================================
  # JOB 3: STATIC APPLICATION SECURITY TESTING (SAST)
  # ============================================================================
  sast:
    name: üî¨ SAST - Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Semgrep Security Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/nodejs
            p/javascript
            p/typescript
            p/jwt

      - name: ESLint Security Scan
        run: |
          cd my-frontend
          npm ci
          npx eslint . --ext .js,.jsx,.ts,.tsx --format json --output-file eslint-results.json || true

      - name: Upload SAST results
        uses: actions/upload-artifact@v3
        with:
          name: sast-results
          path: |
            my-frontend/eslint-results.json

  # ============================================================================
  # JOB 4: CONTAINER SECURITY SCANNING
  # ============================================================================
  container-scan:
    name: üê≥ Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (backend)
        run: |
          docker build -t bisman-erp-backend:${{ github.sha }} ./my-backend

      - name: Trivy Security Scan - Backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: bisman-erp-backend:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-backend.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-backend.sarif'

      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './my-backend'
          format: 'table'
          severity: 'CRITICAL,HIGH'

  # ============================================================================
  # JOB 5: DYNAMIC APPLICATION SECURITY TESTING (DAST)
  # ============================================================================
  dast:
    name: üåê DAST - Dynamic Security Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/staging'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: ${{ secrets.STAGING_URL || 'https://staging.bisman.com' }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -I'

      - name: Upload ZAP results
        uses: actions/upload-artifact@v3
        with:
          name: zap-results
          path: report_html.html

  # ============================================================================
  # JOB 6: LICENSE COMPLIANCE
  # ============================================================================
  license-scan:
    name: üìú License Compliance Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: ['my-backend', 'my-frontend']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install license checker
        run: npm install -g license-checker

      - name: Check licenses
        working-directory: ${{ matrix.directory }}
        run: |
          npm ci
          license-checker --json --out licenses-${{ matrix.directory }}.json
          license-checker --summary

      - name: Upload license report
        uses: actions/upload-artifact@v3
        with:
          name: licenses-${{ matrix.directory }}
          path: ${{ matrix.directory }}/licenses-${{ matrix.directory }}.json

  # ============================================================================
  # JOB 7: INFRASTRUCTURE AS CODE SECURITY
  # ============================================================================
  iac-scan:
    name: üèóÔ∏è IaC Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkov IaC Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: dockerfile,secrets
          output_format: sarif
          output_file_path: checkov-results.sarif

      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: checkov-results.sarif

  # ============================================================================
  # JOB 8: SECURITY SUMMARY REPORT
  # ============================================================================
  security-report:
    name: üìä Generate Security Report
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-scan, sast, container-scan, license-scan]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate summary
        run: |
          echo "# üîê Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST | ${{ needs.sast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Scan | ${{ needs.container-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed reports in workflow artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üîê **Security scans completed!** Check the Actions tab for detailed results.'
            })

  # ============================================================================
  # JOB 9: FAIL ON CRITICAL VULNERABILITIES
  # ============================================================================
  security-gate:
    name: üö® Security Gate
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-scan, sast]
    steps:
      - name: Check for critical issues
        run: |
          echo "Evaluating security scan results..."
          # This job will fail if any critical security checks failed
          # Preventing merge/deployment of vulnerable code

      - name: Security gate passed
        run: |
          echo "‚úÖ All critical security checks passed"
          echo "Code is approved for deployment"
