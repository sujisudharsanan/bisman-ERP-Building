# BISMAN ERP - Alertmanager Configuration
# Routes alerts to appropriate notification channels

global:
  # Global settings
  resolve_timeout: 5m
  
  # SMTP configuration for email alerts
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@bisman.io'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

# Alert routing tree
route:
  # Default receiver
  receiver: 'default-slack'
  
  # Group alerts by alertname and severity
  group_by: ['alertname', 'severity', 'component']
  
  # Wait 30 seconds before sending first notification
  group_wait: 30s
  
  # Wait 5 minutes before sending notifications for new alerts in same group
  group_interval: 5m
  
  # Wait 4 hours before re-sending a notification
  repeat_interval: 4h
  
  # Child routes for specific alert types
  routes:
    # Critical alerts go to PagerDuty immediately
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      group_wait: 10s
      repeat_interval: 1h
      continue: true  # Also send to Slack
      
    # Critical alerts also go to Slack
    - match:
        severity: critical
      receiver: 'slack-critical'
      group_wait: 10s
      repeat_interval: 1h
      
    # Database alerts
    - match:
        component: database
      receiver: 'slack-database'
      group_wait: 30s
      repeat_interval: 2h
      
    # Security alerts (rate limiting, brute force, etc.)
    - match:
        component: security
      receiver: 'slack-security'
      group_wait: 15s
      repeat_interval: 1h
      
    # Backup alerts
    - match:
        component: backup
      receiver: 'email-ops'
      group_wait: 1m
      repeat_interval: 6h
      
    # Tenant-specific alerts
    - match:
        component: tenant
      receiver: 'slack-customer-success'
      group_wait: 5m
      repeat_interval: 4h
      
    # Sentry/Error alerts
    - match:
        component: errors
      receiver: 'slack-engineering'
      group_wait: 2m
      repeat_interval: 2h
      
    # Warning alerts (lower priority)
    - match:
        severity: warning
      receiver: 'slack-warnings'
      group_wait: 5m
      repeat_interval: 6h
      
    # Info alerts (notifications only)
    - match:
        severity: info
      receiver: 'slack-info'
      group_wait: 30m
      repeat_interval: 24h

# Notification receivers
receivers:
  # Default Slack channel
  - name: 'default-slack'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-erp'
        title: '{{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Severity:* {{ .Labels.severity }}
          *Description:* {{ .Annotations.description }}
          *Action:* {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
        
  # Critical Slack channel
  - name: 'slack-critical'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-critical'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Component:* {{ .Labels.component }}
          *Description:* {{ .Annotations.description }}
          *Action Required:* {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
        
  # PagerDuty for critical alerts
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        severity: critical
        description: '{{ .GroupLabels.alertname }}: {{ .Annotations.summary }}'
        details:
          component: '{{ .Labels.component }}'
          description: '{{ .Annotations.description }}'
          action: '{{ .Annotations.action }}'
          
  # Database team Slack channel
  - name: 'slack-database'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-database'
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
        title: 'üóÑÔ∏è Database: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
        
  # Security team Slack channel
  - name: 'slack-security'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-security'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: 'üîí Security: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          *Action:* {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
        
  # Customer success for tenant alerts
  - name: 'slack-customer-success'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#customer-success'
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
        title: 'üë• Tenant Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Tenant:* {{ .Labels.tenant }}
          *Summary:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
        
  # Engineering team for error alerts
  - name: 'slack-engineering'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#engineering-errors'
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
        title: 'üêõ Errors: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
        
  # Ops team email for backup alerts
  - name: 'email-ops'
    email_configs:
      - to: 'ops@bisman.io'
        subject: '[BISMAN ERP] Backup Alert: {{ .GroupLabels.alertname }}'
        html: |
          <h2>Backup Alert</h2>
          {{ range .Alerts }}
          <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Action:</strong> {{ .Annotations.action }}</p>
          {{ end }}
        send_resolved: true
        
  # Warning channel
  - name: 'slack-warnings'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-warnings'
        color: 'warning'
        title: '‚ö†Ô∏è Warning: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
        
  # Info channel (low priority)
  - name: 'slack-info'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-info'
        color: '#3498db'
        title: '‚ÑπÔ∏è Info: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          {{ end }}
        send_resolved: false

# Inhibition rules to suppress certain alerts
inhibit_rules:
  # If API is down, suppress other API alerts
  - source_match:
      alertname: 'ApplicationDown'
    target_match_re:
      alertname: 'High.*|Slow.*'
    equal: ['instance']
    
  # If database is down, suppress query performance alerts
  - source_match:
      alertname: 'DatabaseConnectionError'
    target_match_re:
      alertname: 'SlowDatabaseQueries|HighDatabaseConnections'
    equal: ['instance']
    
  # Critical alerts suppress warnings for same component
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'component']
