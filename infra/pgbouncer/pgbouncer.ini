;; PgBouncer Configuration for BISMAN ERP
;; ========================================
;; This configuration provides connection pooling between the application
;; and PostgreSQL to prevent connection exhaustion.
;;
;; Pool mode: transaction - connections are returned after each transaction
;; This is optimal for web applications and works with Prisma.

[databases]
;; Database routing configuration
;; Format: dbname = host=<host> port=<port> dbname=<actual_db> user=<user> password=<pass>
;;
;; Wildcard: all connections routed to same backend
;; Environment variables are substituted at runtime
* = host=${PG_HOST:-localhost} port=${PG_PORT:-5432} dbname=${PG_DATABASE:-bisman_prod}

;; For specific database mapping (optional):
; bisman_prod = host=postgres.internal port=5432 dbname=bisman_prod
; bisman_staging = host=postgres-staging.internal port=5432 dbname=bisman_staging

[pgbouncer]
;; ============================================================================
;; NETWORK SETTINGS
;; ============================================================================

;; Listen on all interfaces (use 127.0.0.1 if same-host only)
listen_addr = 0.0.0.0

;; Standard PgBouncer port
listen_port = 6432

;; Unix socket directory (optional, for local connections)
; unix_socket_dir = /var/run/pgbouncer

;; ============================================================================
;; AUTHENTICATION
;; ============================================================================

;; Authentication type: md5 is secure and widely compatible
auth_type = md5

;; User credentials file
auth_file = /etc/pgbouncer/userlist.txt

;; Allow passwordless admin access from localhost (for health checks)
admin_users = pgbouncer

;; Users allowed to run SHOW commands
stats_users = pgbouncer, stats

;; ============================================================================
;; POOL SETTINGS
;; ============================================================================

;; Pool mode determines when connections are returned to pool:
;;   session     - connection held for entire client session
;;   transaction - connection returned after each transaction (RECOMMENDED)
;;   statement   - connection returned after each statement
pool_mode = transaction

;; Default number of server connections per user/database pair
;; Tune based on: (max_connections / num_databases / num_users)
default_pool_size = 20

;; Minimum connections to keep open (prevents cold start latency)
min_pool_size = 5

;; Extra connections for burst traffic
reserve_pool_size = 5

;; Seconds to wait before using reserve pool
reserve_pool_timeout = 5

;; Maximum simultaneous client connections to PgBouncer
;; Set high - PgBouncer handles many clients efficiently
max_client_conn = 500

;; Maximum connections to PostgreSQL per database
;; IMPORTANT: Set lower than Postgres max_connections to leave headroom
;; Formula: max_db_connections = postgres_max_connections - admin_reserve (10)
max_db_connections = 90

;; Maximum connections per user (0 = unlimited)
max_user_connections = 0

;; ============================================================================
;; TIMEOUTS
;; ============================================================================

;; Close server connections idle for this many seconds
server_idle_timeout = 600

;; Time to wait for a connection to become available
query_timeout = 0

;; Timeout for connecting to server
server_connect_timeout = 15

;; Timeout for login to server
server_login_retry = 15

;; Client idle timeout (0 = disabled)
client_idle_timeout = 0

;; Close client connection if server login takes too long
client_login_timeout = 60

;; ============================================================================
;; QUERY HANDLING
;; ============================================================================

;; Query to run when connection is returned to pool
;; DISCARD ALL resets all session state (required for transaction mode)
server_reset_query = DISCARD ALL

;; For session mode only (not needed for transaction mode):
; server_reset_query = RESET ALL; SET SESSION AUTHORIZATION DEFAULT;

;; Ignore startup parameters that can't be set on server
ignore_startup_parameters = extra_float_digits

;; ============================================================================
;; LOGGING
;; ============================================================================

;; Log file location (use - for stdout in Docker)
logfile = /var/log/pgbouncer/pgbouncer.log

;; PID file
pidfile = /var/run/pgbouncer/pgbouncer.pid

;; Log connects/disconnects (useful for debugging, disable in production)
log_connections = 1
log_disconnections = 1

;; Log errors from pooler
log_pooler_errors = 1

;; DNS lookup caching (seconds)
dns_max_ttl = 15

;; Verbose logging (0 = off, 1 = on)
verbose = 0

;; ============================================================================
;; TLS/SSL (uncomment for secure connections)
;; ============================================================================

;; Client-side TLS (clients connecting to PgBouncer)
; client_tls_sslmode = prefer
; client_tls_cert_file = /etc/pgbouncer/server.crt
; client_tls_key_file = /etc/pgbouncer/server.key

;; Server-side TLS (PgBouncer connecting to PostgreSQL)
;; Options: disable, allow, prefer, require, verify-ca, verify-full
server_tls_sslmode = prefer

;; For AWS RDS, uncomment these:
; server_tls_sslmode = require
; server_tls_ca_file = /etc/ssl/certs/rds-ca-bundle.pem

;; ============================================================================
;; PERFORMANCE TUNING
;; ============================================================================

;; TCP keepalive settings
tcp_keepalive = 1
tcp_keepidle = 30
tcp_keepintvl = 10
tcp_keepcnt = 3

;; Socket buffer sizes (0 = OS default)
pkt_buf = 4096
sbuf_lookahead = 0

;; Number of accept() calls per event loop iteration
listen_backlog = 128

;; ============================================================================
;; NOTES FOR PRODUCTION
;; ============================================================================
;; 
;; 1. Pool sizing calculation:
;;    - Postgres max_connections = 100 (typical cloud default)
;;    - Leave 10 for admin/monitoring = 90 available
;;    - If 3 app databases, each gets ~30 connections
;;    - default_pool_size = 20-25 per user/db combo
;;
;; 2. For Prisma:
;;    - Use DATABASE_URL with ?pgbouncer=true
;;    - Transaction mode is fully compatible
;;    - Connection limit in Prisma should match pool_size
;;
;; 3. For high availability:
;;    - Run multiple PgBouncer instances behind a load balancer
;;    - Each PgBouncer should have same pool settings
;;
;; 4. Monitoring:
;;    - Connect to pgbouncer database: psql -p 6432 pgbouncer
;;    - SHOW POOLS; SHOW STATS; SHOW CLIENTS;
