// ====================================================================
// BISMAN ERP - IMPROVED PRISMA SCHEMA
// ====================================================================
// Created: November 26, 2025
// Purpose: Normalized, secure, multi-tenant ERP schema for Prisma
// ====================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ====================================================================
// ENUMS
// ====================================================================

enum UserRole {
  SUPER_ADMIN
  ENTERPRISE_ADMIN
  ADMIN
  IT_ADMIN
  CFO
  FINANCE_CONTROLLER
  TREASURY
  ACCOUNTS
  ACCOUNTS_PAYABLE
  ACCOUNTS_RECEIVABLE
  BANKER
  PROCUREMENT_OFFICER
  PROCUREMENT_HEAD
  PROCUREMENT_MANAGER
  SUPPLIER_MANAGER
  OPERATIONS_MANAGER
  WAREHOUSE_MANAGER
  LOGISTICS_MANAGER
  INVENTORY_CONTROLLER
  HUB_INCHARGE
  STORE_INCHARGE
  COMPLIANCE
  COMPLIANCE_OFFICER
  LEGAL
  LEGAL_HEAD
  RISK_MANAGER
  HR
  HR_MANAGER
  STAFF
  MANAGER
  USER
}

enum ProductType {
  BUSINESS_ERP
  PETROL_PUMP_ERP
  LOGISTICS_ERP
  RETAIL_ERP
}

enum AddressType {
  HOME
  OFFICE
  BILLING
  SHIPPING
  WAREHOUSE
  OTHER
}

enum GenderType {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum LoginStatus {
  SUCCESS
  FAILED
  BLOCKED
}

// ====================================================================
// CORE MODELS
// ====================================================================

model Client {
  id                    String    @id @default(uuid()) @db.Uuid
  name                  String    @db.VarChar(255)
  slug                  String    @unique @db.VarChar(100)
  domain                String?   @db.VarChar(255)
  isActive              Boolean   @default(true) @map("is_active")
  subscriptionTier      String?   @map("subscription_tier") @db.VarChar(50)
  subscriptionExpiresAt DateTime? @map("subscription_expires_at") @db.Timestamp(6)
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt             DateTime? @map("deleted_at") @db.Timestamp(6)

  // Relations
  users User[]

  @@index([isActive])
  @@index([deletedAt])
  @@map("clients")
}

model SuperAdmin {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(255)
  email     String   @unique @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  users User[]

  @@map("super_admins")
}

// ====================================================================
// IMPROVED USER MODEL
// ====================================================================

model User {
  id                Int          @id @default(autoincrement())
  username          String       @db.VarChar(100)
  email             String       @unique @db.VarChar(150)
  
  // Authentication
  password          String       @db.VarChar(255)
  passwordChangedAt DateTime     @default(now()) @map("password_changed_at") @db.Timestamp(6)
  lastLoginAt       DateTime?    @map("last_login_at") @db.Timestamp(6)
  
  // Authorization
  role              UserRole     @default(USER)
  
  // Status
  isActive          Boolean      @default(true) @map("is_active")
  deletedAt         DateTime?    @map("deleted_at") @db.Timestamp(6) // Soft delete
  
  // Multi-tenant
  tenantId          String?      @map("tenant_id") @db.Uuid
  productType       ProductType  @default(BUSINESS_ERP) @map("product_type")
  superAdminId      Int?         @map("super_admin_id")
  
  // Timestamps
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime     @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  tenant            Client?              @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  superAdmin        SuperAdmin?          @relation(fields: [superAdminId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  profile           UserProfile?
  addresses         UserAddress[]
  modules           UserModule[]
  pagePermissions   UserPagePermission[]
  loginHistory      LoginHistory[]
  passwordHistory   PasswordHistory[]    @relation("UserPasswords")
  passwordChanges   PasswordHistory[]    @relation("PasswordChanger")
  sessions          UserSession[]

  @@unique([username, tenantId])
  @@index([email])
  @@index([tenantId])
  @@index([isActive])
  @@index([deletedAt])
  @@index([productType])
  @@index([superAdminId])
  @@index([role])
  @@map("users")
}

// ====================================================================
// USER PROFILE & ADDRESS MODELS
// ====================================================================

model UserProfile {
  id                          Int         @id @default(autoincrement())
  userId                      Int         @unique @map("user_id")
  
  // Personal Information
  fullName                    String?     @map("full_name") @db.VarChar(255)
  phone                       String?     @db.VarChar(20)
  phoneVerified               Boolean     @default(false) @map("phone_verified")
  dateOfBirth                 DateTime?   @map("date_of_birth") @db.Date
  gender                      GenderType?
  
  // Profile Media
  profilePicUrl               String?     @map("profile_pic_url") @db.Text
  coverPicUrl                 String?     @map("cover_pic_url") @db.Text
  
  // Additional Info
  bio                         String?     @db.Text
  department                  String?     @db.VarChar(100)
  designation                 String?     @db.VarChar(100)
  employeeId                  String?     @map("employee_id") @db.VarChar(50)
  
  // Emergency Contact
  emergencyContactName        String?     @map("emergency_contact_name") @db.VarChar(255)
  emergencyContactPhone       String?     @map("emergency_contact_phone") @db.VarChar(20)
  emergencyContactRelationship String?    @map("emergency_contact_relationship") @db.VarChar(50)
  
  // Timestamps
  createdAt                   DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt                   DateTime    @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId])
  @@index([phone])
  @@map("user_profiles")
}

model UserAddress {
  id          Int         @id @default(autoincrement())
  userId      Int         @map("user_id")
  
  // Address Type
  addressType AddressType @default(HOME) @map("address_type")
  
  // Address Details
  line1       String      @db.VarChar(255)
  line2       String?     @db.VarChar(255)
  city        String      @db.VarChar(100)
  state       String      @db.VarChar(100)
  postalCode  String      @map("postal_code") @db.VarChar(20)
  country     String      @default("India") @db.VarChar(100)
  
  // Status
  isDefault   Boolean     @default(false) @map("is_default")
  isActive    Boolean     @default(true) @map("is_active")
  
  // Timestamps
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime    @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId])
  @@index([addressType])
  @@index([isDefault])
  @@map("user_addresses")
}

// ====================================================================
// NORMALIZED PERMISSION MODELS
// ====================================================================

model Module {
  id           Int          @id @default(autoincrement())
  moduleKey    String       @unique @map("module_key") @db.VarChar(100)
  moduleName   String       @map("module_name") @db.VarChar(255)
  description  String?      @db.Text
  icon         String?      @db.VarChar(50)
  displayOrder Int?         @map("display_order")
  isActive     Boolean      @default(true) @map("is_active")
  productType  ProductType? @map("product_type")
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  userModules UserModule[]
  pages       Page[]

  @@index([moduleKey])
  @@index([productType])
  @@map("modules")
}

model UserModule {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  moduleKey String   @map("module_key") @db.VarChar(100)
  
  // Permission
  isEnabled Boolean  @default(true) @map("is_enabled")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  module Module @relation(fields: [moduleKey], references: [moduleKey], onDelete: Cascade, onUpdate: Cascade)

  @@unique([userId, moduleKey])
  @@index([userId])
  @@index([moduleKey])
  @@index([isEnabled])
  @@map("user_modules")
}

model Page {
  id           Int          @id @default(autoincrement())
  pageKey      String       @unique @map("page_key") @db.VarChar(100)
  route        String       @db.VarChar(255)
  pageName     String       @map("page_name") @db.VarChar(255)
  description  String?      @db.Text
  moduleKey    String?      @map("module_key") @db.VarChar(100)
  icon         String?      @db.VarChar(50)
  displayOrder Int?         @map("display_order")
  isActive     Boolean      @default(true) @map("is_active")
  productType  ProductType? @map("product_type")
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  module          Module?              @relation(fields: [moduleKey], references: [moduleKey], onDelete: SetNull, onUpdate: Cascade)
  userPermissions UserPagePermission[]

  @@index([pageKey])
  @@index([route])
  @@index([moduleKey])
  @@map("pages")
}

model UserPagePermission {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  pageKey    String   @map("page_key") @db.VarChar(100)
  
  // CRUD Permissions
  canView    Boolean  @default(false) @map("can_view")
  canCreate  Boolean  @default(false) @map("can_create")
  canUpdate  Boolean  @default(false) @map("can_update")
  canDelete  Boolean  @default(false) @map("can_delete")
  canExport  Boolean  @default(false) @map("can_export")
  canApprove Boolean  @default(false) @map("can_approve")
  
  // Timestamps
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  page Page @relation(fields: [pageKey], references: [pageKey], onDelete: Cascade, onUpdate: Cascade)

  @@unique([userId, pageKey])
  @@index([userId])
  @@index([pageKey])
  @@map("user_page_permissions")
}

// ====================================================================
// AUDIT & SECURITY MODELS
// ====================================================================

model LoginHistory {
  id            Int         @id @default(autoincrement())
  userId        Int?        @map("user_id")
  email         String      @db.VarChar(150)
  ipAddress     String?     @map("ip_address") @db.Inet
  userAgent     String?     @map("user_agent") @db.Text
  loginStatus   LoginStatus @map("login_status")
  failureReason String?     @map("failure_reason") @db.VarChar(255)
  sessionId     String?     @map("session_id") @db.VarChar(255)
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([userId])
  @@index([email])
  @@index([createdAt(sort: Desc)])
  @@index([loginStatus])
  @@map("login_history")
}

model PasswordHistory {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  passwordHash String   @map("password_hash") @db.VarChar(255)
  changedBy    Int?     @map("changed_by")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user     User  @relation("UserPasswords", fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  changer  User? @relation("PasswordChanger", fields: [changedBy], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("password_history")
}

model UserSession {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  sessionToken    String   @unique @map("session_token") @db.VarChar(255)
  refreshToken    String?  @unique @map("refresh_token") @db.VarChar(255)
  ipAddress       String?  @map("ip_address") @db.Inet
  userAgent       String?  @map("user_agent") @db.Text
  expiresAt       DateTime @map("expires_at") @db.Timestamp(6)
  lastActivityAt  DateTime @default(now()) @map("last_activity_at") @db.Timestamp(6)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([isActive])
  @@index([expiresAt])
  @@map("user_sessions")
}
